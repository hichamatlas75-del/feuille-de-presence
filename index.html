<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grey Corner â€¢ Gestion Excellence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1e293b; --accent: #c5a059; --bg: #faf9f6; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--primary); }
        .section-header { border-left: 3px solid var(--accent); padding-left: 12px; margin: 24px 0 12px 0; }
        .staff-card { background: white; border: 1px solid rgba(0,0,0,0.03); transition: all 0.2s ease; }
        .staff-card:hover { border-color: var(--accent); }
        input[type="time"] { -webkit-appearance: none; min-height: 40px; }
        .badge-poste { font-size: 9px; letter-spacing: 0.05em; background: #f1f5f9; color: #64748b; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <header class="max-w-2xl mx-auto mb-10 text-center relative">
        <div class="mb-2 text-[10px] tracking-[0.2em] font-bold text-[#c5a059] uppercase">FÃ¨s â€” Maroc</div>
        <h1 class="text-3xl font-extrabold tracking-tighter mb-6 text-slate-900">GREY CORNER</h1>
        
        <button id="managerToggle" onclick="toggleManager()" class="py-2 px-4 rounded-full text-[10px] font-bold border border-[#c5a059] text-[#c5a059] bg-white transition-all hover:bg-[#c5a059] hover:text-white">
            ðŸ”“ ACCÃˆS GÃ‰RANT
        </button>

        <div class="mt-8">
            <input type="date" id="datePicker" class="w-full p-4 rounded-2xl border-none shadow-sm font-semibold text-sm focus:ring-2 focus:ring-[#c5a059] outline-none bg-white">
        </div>
    </header>

    <div class="max-w-2xl mx-auto">
        <button class="w-full bg-[#1e293b] text-white font-bold py-4 px-6 rounded-2xl mb-10 shadow-lg flex items-center justify-center gap-3 active:scale-[0.98] transition-transform" onclick="downloadPDF()">
            <span>GÃ‰NÃ‰RER LE RAPPORT JOURNALIER</span>
        </button>

        <div id="report-area">
            <div id="staffList" class="space-y-8">
                </div>
        </div>
    </div>

    <footer class="mt-20 text-center text-slate-400 text-[9px] font-bold uppercase tracking-[0.3em] pb-10">
        &copy; 2026 Grey Corner â€¢ Service & HospitalitÃ©
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = { databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let isManager = false;
        
        const EQUIPE = [
            {nom: 'ALAOUI', prenom: 'LAZIZ', poste: 'SERVICE'}, {nom: 'BELQASSE', prenom: 'KHAOULA', poste: 'CUISINE'},
            {nom: 'BENKHADA', prenom: 'ABDESLAM', poste: 'CAISSE'}, {nom: 'BOURAHMA', prenom: 'ANAS', poste: 'CUISINE'},
            {nom: 'CHKAIRI', prenom: 'YOUSSEF', poste: 'BAR'}, {nom: 'ELKOBBI', prenom: 'MOSTAFA', poste: 'BAR'},
            {nom: 'ELGORRAMY', prenom: 'ANISSA', poste: 'MENAGE'}, {nom: 'ELGORRAMY', prenom: 'SOUAD', poste: 'MENAGE'},
            {nom: 'ELMCHAOURI', prenom: 'SOUAD', poste: 'MENAGE'}, {nom: 'ENNHAILI', prenom: 'SOUMIA', poste: 'ECONOMAT'},
            {nom: 'FILALI', prenom: 'ABDERAFI', poste: 'BAR'}, {nom: 'GUETIBI', prenom: 'AMINE', poste: 'SERVICE'},
            {nom: 'HATTAF', prenom: 'MOHAMED', poste: 'SERVICE'}, {nom: 'HIDARA', prenom: 'YOUSSEF', poste: 'SERVICE'},
            {nom: 'IDRISSI', prenom: 'SAAD', poste: 'CUISINE'}, {nom: 'KAFOUNI', prenom: 'ZAKARIAE', poste: 'SERVICE'},
            {nom: 'KHALOUQ', prenom: 'RACHID', poste: 'BAR'}, {nom: 'LEMSSIEH', prenom: 'JAWAD', poste: 'CUISINE'},
            {nom: 'MAJDOUB', prenom: 'JIHANE', poste: 'CUISINE'}, {nom: 'MOHSINE', prenom: 'YOUNESS', poste: 'SERVICE'},
            {nom: 'MOUJAHID', prenom: 'IMANE', poste: 'CUISINE'}, {nom: 'SALIL', prenom: 'HOUDA', poste: 'CAISSE'},
            {nom: 'SBAI', prenom: 'HAKIMA', poste: 'MENAGE'}, {nom: 'ZAIR', prenom: 'FATIMA', poste: 'CUISINE'}
        ];

        const getMarocDate = () => new Intl.DateTimeFormat('fr-CA', {timeZone: 'Africa/Casablanca', year: 'numeric', month: '2-digit', day: '2-digit'}).format(new Date());

        function initApp() {
            const dp = document.getElementById('datePicker');
            dp.value = getMarocDate();
            dp.addEventListener('change', load);
            load();
        }

        function toggleManager() {
            if(!isManager) {
                if(prompt("Code Manager :") === "2026") {
                    isManager = true;
                    const btn = document.getElementById('managerToggle');
                    btn.innerHTML = "ðŸ”’ MODE GÃ‰RANT ACTIF";
                    btn.className = "py-2 px-4 rounded-full text-[10px] font-bold bg-[#e67e22] text-white";
                }
            } else {
                isManager = false;
                location.reload();
            }
            load();
        }

        function load() {
            const selectedDate = document.getElementById('datePicker').value;
            const exceptions = ["ELMCHAOURI_SOUAD", "SBAI_HAKIMA", "KHALOUQ_RACHID"];
            
            database.ref('presences/' + selectedDate).on('value', snap => {
                const data = snap.val() || {};
                const list = document.getElementById('staffList');
                list.innerHTML = '';

                // Groupement par poste
                const groupes = EQUIPE.reduce((acc, emp) => {
                    (acc[emp.poste] = acc[emp.poste] || []).push(emp);
                    return acc;
                }, {});

                // Tri alphabÃ©tique des postes
                Object.keys(groupes).sort().forEach(poste => {
                    const section = document.createElement('div');
                    section.innerHTML = `<h2 class="section-header text-xs font-black tracking-widest text-slate-400 uppercase mb-4">${poste}</h2>`;
                    
                    const grid = document.createElement('div');
                    grid.className = "space-y-3";

                    groupes[poste].sort((a,b) => a.nom.localeCompare(b.nom)).forEach(emp => {
                        const id = `${emp.nom}_${emp.prenom}`;
                        const d = data[id] || {};
                        const estEx = exceptions.includes(id);
                        const lock = (selectedDate !== getMarocDate()) && !isManager;
                        const peutSaisirHA = isManager || (estEx && selectedDate === getMarocDate());

                        const card = document.createElement('div');
                        card.className = "staff-card p-4 rounded-2xl flex flex-col gap-4";
                        card.innerHTML = `
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-sm tracking-tight text-slate-800">${emp.nom} ${emp.prenom} ${estEx?'<span class="text-[#c5a059]">ðŸŒ¿</span>':''}</span>
                                <div class="flex gap-2 items-center bg-slate-50 p-1 rounded-lg border border-slate-100">
                                    <div class="flex flex-col items-center px-1">
                                        <span class="text-[7px] font-bold text-slate-400">IN</span>
                                        <input type="checkbox" onchange="upd('${id}','on',this.checked)" ${d.on?'checked':''} ${lock?'disabled':''} class="w-3.5 h-3.5 accent-[#c5a059]">
                                    </div>
                                    <div class="flex flex-col items-center px-1">
                                        <span class="text-[7px] font-bold text-slate-400">OUT</span>
                                        <input type="checkbox" onchange="upd('${id}','off',this.checked)" ${d.off?'checked':''} ${lock?'disabled':''} class="w-3.5 h-3.5 accent-[#c5a059]">
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Shift PrÃ©vu</label>
                                    <input type="time" onchange="upd('${id}','hP',this.value)" value="${d.hP||''}" ${lock?'disabled':''} 
                                           class="w-full bg-slate-50 border-none rounded-xl text-xs font-medium p-2 outline-none focus:ring-1 focus:ring-[#c5a059]">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">ArrivÃ©e RÃ©elle</label>
                                    ${peutSaisirHA ? 
                                        `<input type="time" onchange="upd('${id}','hA',this.value)" value="${d.hA||''}" class="w-full bg-[#fdfaf6] border border-[#c5a059]/20 rounded-xl text-xs font-bold p-2 outline-none">` :
                                        `<div class="w-full bg-slate-100 rounded-xl text-xs font-bold p-2 text-slate-400 text-center">${d.hA || '--:--'}</div>`
                                    }
                                </div>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                    section.appendChild(grid);
                    list.appendChild(section);
                });
            });
        }

        function upd(id, f, v) { 
            const date = document.getElementById('datePicker').value;
            database.ref('presences/'+date+'/'+id).update({[f]:v}); 
        }

        function downloadPDF() {
            const element = document.getElementById('report-area');
            const date = document.getElementById('datePicker').value;
            html2pdf().set({ 
                margin: 10, filename: `GC_PRESENCE_${date}.pdf`, 
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { scale: 3 },
                jsPDF: { unit:'mm', format:'a4', orientation:'portrait' } 
            }).from(element).save();
        }

        initApp();
    </script>
</body>
</html>
