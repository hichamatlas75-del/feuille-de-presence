<script>
    const employesInit = [
        {nom: 'SALIL', prenom: 'HOUDA', fonction: 'CAISSE'},
        {nom: 'BENKHADA', prenom: 'ABDESLAM', fonction: 'CAISSE'},
        {nom: 'ENNHAIlI', prenom: 'SOUMIA', fonction: 'EXONOMAT 07:45'},
        {nom: 'CHKAIRI', prenom: 'YOUSSEF', fonction: 'BAR'},
        {nom: 'KHALOUQ', prenom: 'RACHID', fonction: 'BAR'},
        {nom: 'FILALI', prenom: 'ABDERAFI', fonction: 'BAR'},
        {nom: 'EL KOBBI', prenom: 'MOSTAFA', fonction: 'BAR'},
        {nom: 'SBAI', prenom: 'HAKIMA', fonction: 'MENAGE'},
        {nom: 'ELGORRAMY', prenom: 'SOUAD', fonction: 'MENAGE'},
        {nom: 'ELGORRAMY', prenom: 'ANISSA', fonction: 'MENAGE'},
        {nom: 'ELMCHAOURI', prenom: 'SOUAD', fonction: 'MENAGE'},
        {nom: 'ZAIR', prenom: 'FATIMA', fonction: 'CUISINE'},
        {nom: 'BELQASSE', prenom: 'KHAOULA', fonction: 'CUISINE'},
        {nom: 'MAJDOUB', prenom: 'JIHANE', fonction: 'CUISINE'},
        {nom: 'LEMSSIEH', prenom: 'JAWAD', fonction: 'CUISINE'},
        {nom: 'BOURAHMA', prenom: 'ANAS', fonction: 'CUISINE'},
        {nom: 'MOUJAHID', prenom: 'IMANE', fonction: 'CUISINE'},
        {nom: 'IDRISSI', prenom: 'SAAD', fonction: 'CUISINE'},
        {nom: 'GUETIBI', prenom: 'AMINE', fonction: 'SERVICE'},
        {nom: 'EL MOEDEN', prenom: 'HASSAN', fonction: 'SERVICE'},
        {nom: 'HIDARA', prenom: 'YOUSSEF', fonction: 'SERVICE'},
        {nom: 'ALAOUI', prenom: 'LAZIZ', fonction: 'SERVICE'},
        {nom: 'HATTAF', prenom: 'MOHAMED', fonction: 'SERVICE'},
        {nom: 'MOHSINE', prenom: 'YOUNESS', fonction: 'SERVICE'}
    ];

    let employes = JSON.parse(localStorage.getItem('employesPresence')) || employesInit;

    function sauvegarderDonnees() {
        const date = document.getElementById('date').value;
        if (!date) {
            alert('⚠️ Veuillez choisir une date.');
            return;
        }

        const lignes = document.querySelectorAll('#tablePresence tbody tr');
        const dateData = {};

        lignes.forEach((ligne, index) => {
            const inputs = ligne.querySelectorAll('input');
            const emp = employes[index];
            if (!emp) return;

            const key = emp.nom + '_' + emp.prenom;

            // Correction des index :
            // inputs[0] = checkbox ON, inputs[1] = checkbox OFF, 
            // inputs[2] = H. Prévue, inputs[3] = H. Arrivée, inputs[4] = Signature
            dateData[key] = {
                on: inputs[0].checked,
                off: inputs[1].checked,
                heurePrevue: inputs[2].value,
                heureArrivee: inputs[3].value,
                signature: inputs[4].value
            };
        });

        localStorage.setItem('donneesPresence_' + date, JSON.stringify(dateData));
        localStorage.setItem('employesPresence', JSON.stringify(employes));
        
        alert('✅ Présences sauvegardées avec soin pour le ' + date);
    }

    function afficherTable() {
        const tbody = document.querySelector('#tablePresence tbody');
        const date = document.getElementById('date').value;
        
        tbody.innerHTML = '';

        const savedData = localStorage.getItem('donneesPresence_' + date);
        const donneesJour = savedData ? JSON.parse(savedData) : {};

        employes.forEach(emp => {
            const key = emp.nom + '_' + emp.prenom;
            const d = donneesJour[key] || {};

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${emp.nom} ${emp.prenom}</td>
                <td>${emp.fonction}</td>
                <td><input type="checkbox" ${d.on ? 'checked' : ''}></td>
                <td><input type="checkbox" ${d.off ? 'checked' : ''}></td>
                <td><input type="time" value="${d.heurePrevue || ''}"></td>
                <td><input type="time" value="${d.heureArrivee || ''}"></td>
                <td><input type="text" placeholder="Sig." value="${d.signature || ''}"></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function ajouterEmploye() {
        const nom = document.getElementById('nomAjout').value.toUpperCase().trim();
        const prenom = document.getElementById('prenomAjout').value.toUpperCase().trim();
        const fonction = document.getElementById('fonctionAjout').value.toUpperCase().trim();
        
        if (nom && prenom) {
            employes.push({nom, prenom, fonction});
            localStorage.setItem('employesPresence', JSON.stringify(employes));
            // Réinitialiser les champs
            document.getElementById('nomAjout').value = '';
            document.getElementById('prenomAjout').value = '';
            document.getElementById('fonctionAjout').value = '';
            afficherTable();
        } else {
            alert("Veuillez saisir au moins un nom et un prénom.");
        }
    }

    function restaurerListe() {
        if (confirm('Voulez-vous restaurer la liste initiale des employés ?')) {
            employes = [...employesInit];
            localStorage.setItem('employesPresence', JSON.stringify(employes));
            afficherTable();
        }
    }

    function imprimer() {
        window.print();
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Définir la date d'aujourd'hui par défaut
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
        
        document.getElementById('date').addEventListener('change', afficherTable);
        afficherTable();
    });
</script>
