<script>
    const employesInit = [
        {nom: 'SALIL', prenom: 'HOUDA', fonction: 'CAISSE'},
        {nom: 'BENKHADA', prenom: 'ABDESLAM', fonction: 'CAISSE'},
        {nom: 'ENNHAIlI', prenom: 'SOUMIA', fonction: 'EXONOMAT 07:45'},
        {nom: 'CHKAIRI', prenom: 'YOUSSEF', fonction: 'BAR'},
        {nom: 'KHALOUQ', prenom: 'RACHID', fonction: 'BAR'},
        {nom: 'FILALI', prenom: 'ABDERAFI', fonction: 'BAR'},
        {nom: 'EL KOBBI', prenom: 'MOSTAFA', fonction: 'BAR'},
        {nom: 'SBAI', prenom: 'HAKIMA', fonction: 'MENAGE'},
        {nom: 'ELGORRAMY', prenom: 'SOUAD', fonction: 'MENAGE'},
        {nom: 'ELGORRAMY', prenom: 'ANISSA', fonction: 'MENAGE'},
        {nom: 'ELMCHAOURI', prenom: 'SOUAD', fonction: 'MENAGE'},
        {nom: 'ZAIR', prenom: 'FATIMA', fonction: 'CUISINE'},
        {nom: 'BELQASSE', prenom: 'KHAOULA', fonction: 'CUISINE'},
        {nom: 'MAJDOUB', prenom: 'JIHANE', fonction: 'CUISINE'},
        {nom: 'LEMSSIEH', prenom: 'JAWAD', fonction: 'CUISINE'},
        {nom: 'BOURAHMA', prenom: 'ANAS', fonction: 'CUISINE'},
        {nom: 'MOUJAHID', prenom: 'IMANE', fonction: 'CUISINE'},
        {nom: 'IDRISSI', prenom: 'SAAD', fonction: 'CUISINE'},
        {nom: 'GUETIBI', prenom: 'AMINE', fonction: 'SERVICE'},
        {nom: 'EL MOEDEN', prenom: 'HASSAN', fonction: 'SERVICE'},
        {nom: 'HIDARA', prenom: 'YOUSSEF', fonction: 'SERVICE'},
        {nom: 'ALAOUI', prenom: 'LAZIZ', fonction: 'SERVICE'},
        {nom: 'HATTAF', prenom: 'MOHAMED', fonction: 'SERVICE'},
        {nom: 'MOHSINE', prenom: 'YOUNESS', fonction: 'SERVICE'}
    ];

    let employes = JSON.parse(localStorage.getItem('employesPresence')) || employesInit;

    function afficherTable() {
        const tbody = document.querySelector('#tablePresence tbody');
        const dateSelectionnee = document.getElementById('date').value;
        
        tbody.innerHTML = '';

        // Récupération des données pour cette date spécifique
        const storageKey = 'donneesPresence_' + dateSelectionnee;
        const savedData = localStorage.getItem(storageKey);
        const donneesJour = savedData ? JSON.parse(savedData) : {};

        employes.forEach((emp, index) => {
            const key = emp.nom + '_' + emp.prenom;
            const d = donneesJour[key] || {};

            const tr = document.createElement('tr');
            // On utilise des classes pour cibler les inputs sans se tromper d'index
            tr.innerHTML = `
                <td>${emp.nom} ${emp.prenom}</td>
                <td>${emp.fonction}</td>
                <td><input type="checkbox" class="check-on" ${d.on ? 'checked' : ''}></td>
                <td><input type="checkbox" class="check-off" ${d.off ? 'checked' : ''}></td>
                <td><input type="time" class="time-prevu" value="${d.heurePrevue || ''}"></td>
                <td><input type="time" class="time-arrive" value="${d.heureArrivee || ''}"></td>
                <td><input type="text" class="input-sig" placeholder="Sig." value="${d.signature || ''}"></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function sauvegarderDonnees() {
        const dateSelectionnee = document.getElementById('date').value;
        if (!dateSelectionnee) {
            alert('⚠️ Veuillez sélectionner une date.');
            return;
        }

        const lignes = document.querySelectorAll('#tablePresence tbody tr');
        const dateData = {};

        lignes.forEach((ligne, index) => {
            const emp = employes[index];
            if (emp) {
                const key = emp.nom + '_' + emp.prenom;
                dateData[key] = {
                    on: ligne.querySelector('.check-on').checked,
                    off: ligne.querySelector('.check-off').checked,
                    heurePrevue: ligne.querySelector('.time-prevu').value,
                    heureArrivee: ligne.querySelector('.time-arrive').value,
                    signature: ligne.querySelector('.input-sig').value
                };
            }
        });

        // Sauvegarde par date
        localStorage.setItem('donneesPresence_' + dateSelectionnee, JSON.stringify(dateData));
        // Sauvegarde de la liste des employés au cas où elle a été modifiée
        localStorage.setItem('employesPresence', JSON.stringify(employes));
        
        alert('✅ Les présences ont été enregistrées avec succès pour le ' + dateSelectionnee);
    }

    function ajouterEmploye() {
        const nom = document.getElementById('nomAjout').value.toUpperCase().trim();
        const prenom = document.getElementById('prenomAjout').value.toUpperCase().trim();
        const fonction = document.getElementById('fonctionAjout').value.toUpperCase().trim();
        
        if (nom && prenom) {
            employes.push({nom, prenom, fonction});
            localStorage.setItem('employesPresence', JSON.stringify(employes));
            document.getElementById('nomAjout').value = '';
            document.getElementById('prenomAjout').value = '';
            document.getElementById('fonctionAjout').value = '';
            afficherTable();
        } else {
            alert("Merci de renseigner le nom et le prénom de l'équipier.");
        }
    }

    function restaurerListe() {
        if (confirm('Voulez-vous réinitialiser la liste à 24 employés ?')) {
            localStorage.clear(); // Nettoyage complet si nécessaire
            employes = [...employesInit];
            localStorage.setItem('employesPresence', JSON.stringify(employes));
            location.reload(); // Recharge la page pour tout remettre à zéro proprement
        }
    }

    function imprimer() {
        window.print();
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Initialisation de la date si vide
        if(!document.getElementById('date').value) {
            document.getElementById('date').value = '2026-01-18';
        }
        
        document.getElementById('date').addEventListener('change', afficherTable);
        afficherTable();
    });
</script>
