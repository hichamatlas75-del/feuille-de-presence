<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gestion Pr√©sence - Grey Corner</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; padding: 15px; background: #fdfaf6; color: #444;
        }
        h1 { font-size: 1.4em; color: #2c3e50; text-align: center; margin-bottom: 20px; }
        
        .header { 
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; 
        }
        .header input, .header button { 
            flex: 1; min-width: 130px; padding: 12px; font-size: 15px; border-radius: 8px; border: 1px solid #ddd;
        }
        .btn-save { background: #4CAF50; color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-print { background: #555; color: white; border: none; cursor: pointer; }
        .btn-reset { background: #e74c3c; color: white; border: none; cursor: pointer; }

        .add-form { 
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee;
        }
        .add-form h3 { margin: 0 0 10px 0; font-size: 1em; color: #7f8c8d; }
        .add-form input { width: 100%; margin: 5px 0; padding: 10px; border: 1px solid #eee; border-radius: 6px; }
        .btn-add { width: 100%; padding: 12px; background: #3498db; color: white; border: none; border-radius: 6px; margin-top: 5px; cursor: pointer; }

        .table-container { 
            overflow-x: auto; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px 8px; text-align: center; font-size: 13px; }
        th { background: #f8f9fa; color: #7f8c8d; font-weight: 600; text-transform: uppercase; font-size: 11px; }
        
        .name-cell { text-align: left; font-weight: bold; color: #2c3e50; min-width: 150px; }
        input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; }
        input[type="time"], input[type="text"] { width: 100%; border: 1px solid #f0f0f0; padding: 5px; border-radius: 4px; }

        @media print {
            .add-form, .header button:not(.btn-print) { display: none; }
            body { padding: 0; }
            .table-container { box-shadow: none; }
        }
    </style>
</head>
<body>

    <h1>üåø Pr√©sences Grey Corner F√®s</h1>

    <div class="header">
        <input type="date" id="datePicker">
        <button class="btn-save" id="saveBtn" onclick="sauvegarder()">üíæ Sauvegarder en Ligne</button>
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimer</button>
        <button class="btn-reset" onclick="resetTout()">üîÑ Reset</button>
    </div>

    <div class="add-form">
        <h3>‚ûï Ajouter un membre √† l'√©quipe</h3>
        <input type="text" id="addNom" placeholder="NOM">
        <input type="text" id="addPrenom" placeholder="Pr√©nom">
        <input type="text" id="addFonction" placeholder="Poste (ex: CUISINE)">
        <button class="btn-add" onclick="ajouterMembre()">Ajouter √† la liste</button>
    </div>

    <div class="table-container">
        <table id="tablePresence">
            <thead>
                <tr>
                    <th>Nom & Pr√©nom</th>
                    <th>Poste</th>
                    <th>ON</th>
                    <th>OFF</th>
                    <th>H. Pr√©vue</th>
                    <th>H. Arriv√©e</th>
                    <th>Signature</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const urlScript = "https://script.google.com/macros/s/AKfycbwNXY6UXFyfUgHdQo_P5gKObWfxncOzX2WtDmCgoPn15_mQP8iydwyr1wYOvMY4psu6/exec";

        const equipeInitiale = [
            {nom: 'SALIL', prenom: 'HOUDA', fonction: 'CAISSE'},
            {nom: 'BENKHADA', prenom: 'ABDESLAM', fonction: 'CAISSE'},
            {nom: 'ENNHAIlI', prenom: 'SOUMIA', fonction: 'EXONOMAT 07:45'},
            {nom: 'CHKAIRI', prenom: 'YOUSSEF', fonction: 'BAR'},
            {nom: 'KHALOUQ', prenom: 'RACHID', fonction: 'BAR'},
            {nom: 'FILALI', prenom: 'ABDERAFI', fonction: 'BAR'},
            {nom: 'EL KOBBI', prenom: 'MOSTAFA', fonction: 'BAR'},
            {nom: 'SBAI', prenom: 'HAKIMA', fonction: 'MENAGE'},
            {nom: 'ELGORRAMY', prenom: 'SOUAD', fonction: 'MENAGE'},
            {nom: 'ELGORRAMY', prenom: 'ANISSA', fonction: 'MENAGE'},
            {nom: 'ELMCHAOURI', prenom: 'SOUAD', fonction: 'MENAGE'},
            {nom: 'ZAIR', prenom: 'FATIMA', fonction: 'CUISINE'},
            {nom: 'BELQASSE', prenom: 'KHAOULA', fonction: 'CUISINE'},
            {nom: 'MAJDOUB', prenom: 'JIHANE', fonction: 'CUISINE'},
            {nom: 'LEMSSIEH', prenom: 'JAWAD', fonction: 'CUISINE'},
            {nom: 'BOURAHMA', prenom: 'ANAS', fonction: 'CUISINE'},
            {nom: 'MOUJAHID', prenom: 'IMANE', fonction: 'CUISINE'},
            {nom: 'IDRISSI', prenom: 'SAAD', fonction: 'CUISINE'},
            {nom: 'GUETIBI', prenom: 'AMINE', fonction: 'SERVICE'},
            {nom: 'EL MOEDEN', prenom: 'HASSAN', fonction: 'SERVICE'},
            {nom: 'HIDARA', prenom: 'YOUSSEF', fonction: 'SERVICE'},
            {nom: 'ALAOUI', prenom: 'LAZIZ', fonction: 'SERVICE'},
            {nom: 'HATTAF', prenom: 'MOHAMED', fonction: 'SERVICE'},
            {nom: 'MOHSINE', prenom: 'YOUNESS', fonction: 'SERVICE'}
        ];

        let equipeActuelle = JSON.parse(localStorage.getItem('equipe_grey_corner')) || equipeInitiale;

        function afficher() {
            const date = document.getElementById('datePicker').value;
            const tbody = document.querySelector('#tablePresence tbody');
            tbody.innerHTML = '';
            const dataSauvegardee = JSON.parse(localStorage.getItem('presence_' + date)) || {};

            equipeActuelle.forEach((pers, index) => {
                const id = pers.nom + '_' + pers.prenom;
                const d = dataSauvegardee[id] || {};
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="name-cell">${pers.nom} ${pers.prenom}</td>
                    <td>${pers.fonction}</td>
                    <td><input type="checkbox" class="c-on" ${d.on ? 'checked' : ''}></td>
                    <td><input type="checkbox" class="c-off" ${d.off ? 'checked' : ''}></td>
                    <td><input type="time" class="t-pre" value="${d.hPre || ''}"></td>
                    <td><input type="time" class="t-arr" value="${d.hArr || ''}"></td>
                    <td><input type="text" class="i-sig" value="${d.sig || ''}"></td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function sauvegarder() {
            const date = document.getElementById('datePicker').value;
            if(!date) return alert("S√©lectionnez une date.");
            
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerText = "‚è≥ Envoi en cours...";

            const lignes = document.querySelectorAll('#tablePresence tbody tr');
            const dataLocale = {};
            const listePresences = [];

            lignes.forEach((tr, i) => {
                const pers = equipeActuelle[i];
                const id = pers.nom + '_' + pers.prenom;
                
                const record = {
                    on: tr.querySelector('.c-on').checked,
                    off: tr.querySelector('.c-off').checked,
                    hPre: tr.querySelector('.t-pre').value,
                    hArr: tr.querySelector('.t-arr').value,
                    sig: tr.querySelector('.i-sig').value
                };

                dataLocale[id] = record;
                
                listePresences.push({
                    nomPrenom: pers.nom + ' ' + pers.prenom,
                    fonction: pers.fonction,
                    on: record.on,
                    off: record.off,
                    hPrevue: record.hPre,
                    hArrivee: record.hArr,
                    signature: record.sig
                });
            });

            // 1. Sauvegarde locale (toujours utile)
            localStorage.setItem('presence_' + date, JSON.stringify(dataLocale));

            // 2. Envoi vers Google Sheets
            try {
                await fetch(urlScript, {
                    method: 'POST',
                    mode: 'no-cors', // Important pour Google Apps Script
                    cache: 'no-cache',
                    body: JSON.stringify({ date: date, presences: listePresences })
                });
                alert("‚úÖ Succ√®s ! Les donn√©es sont synchronis√©es sur Google Sheets.");
            } catch (error) {
                alert("‚ö†Ô∏è Erreur de r√©seau, mais les donn√©es sont sauv√©es sur cet appareil.");
            } finally {
                btn.disabled = false;
                btn.innerText = "üíæ Sauvegarder en Ligne";
            }
        }

        function ajouterMembre() {
            const n = document.getElementById('addNom').value.toUpperCase();
            const p = document.getElementById('addPrenom').value;
            const f = document.getElementById('addFonction').value;
            if(n && p) {
                equipeActuelle.push({nom: n, prenom: p, fonction: f});
                localStorage.setItem('equipe_grey_corner', JSON.stringify(equipeActuelle));
                afficher();
            }
        }

        function resetTout() {
            if(confirm("Voulez-vous restaurer la liste par d√©faut ?")) {
                localStorage.clear();
                location.reload();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('datePicker').value = today;
            document.getElementById('datePicker').addEventListener('change', afficher);
            afficher();
        });
    </script>
</body>
</html>
