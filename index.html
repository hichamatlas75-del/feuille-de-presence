<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Grey Corner ‚Ä¢ Pr√©sences (Auth + R√¥les)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --primary:#0f172a;
      --muted:#64748b;
      --accent:#c5a059;
      --bg:#f7f6f2;
      --card:#ffffff;
      --soft:#eef2f7;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--primary)}
    .glass{background:rgba(255,255,255,.75);backdrop-filter: blur(10px)}
    .card{background:var(--card);border:1px solid rgba(2,6,23,.06)}
    .btn{transition:transform .08s ease, filter .2s ease}
    .btn:active{transform:scale(.985)}
    input[type="time"], input[type="date"], input[type="email"], input[type="password"]{-webkit-appearance:none;min-height:42px}
    .chip{border:1px solid rgba(2,6,23,.10)}
    .chip.active{border-color: rgba(197,160,89,.55); background: rgba(197,160,89,.10)}
    .sectionTitle{border-left: 3px solid var(--accent);padding-left: 12px;}
    .badge{
      font-size: 10px; letter-spacing: .06em; text-transform: uppercase;
      font-weight: 800; padding: 4px 8px; border-radius: 999px;
      border: 1px solid rgba(2,6,23,.08);
      background: rgba(15,23,42,.04);
      color: var(--muted); line-height: 1; white-space: nowrap;
    }
    .badge.ok{background: rgba(16,185,129,.10); border-color: rgba(16,185,129,.30); color: #065f46;}
    .badge.warn{background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.32); color: #92400e;}
    .badge.bad{background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.30); color: #7f1d1d;}
    .accentRing:focus{outline:none;box-shadow:0 0 0 3px rgba(197,160,89,.25)}
    .toggleWrap{background: rgba(15,23,42,.04); border:1px solid rgba(2,6,23,.08)}
    .shadowSoft{box-shadow:0 12px 28px rgba(2,6,23,.08)}
    .stickyTop{position:sticky;top:0;z-index:50}

    /* Auth modal */
    .modalWrap{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background: rgba(2,6,23,.55); backdrop-filter: blur(6px);
      z-index:9999;
      padding:18px;
    }
    .modal{
      width:min(520px, 100%);
      border-radius:24px;
      background:#fff;
      border:1px solid rgba(2,6,23,.10);
      box-shadow: 0 20px 60px rgba(2,6,23,.25);
      overflow:hidden;
    }
    .modalHead{
      padding:18px 18px 12px 18px;
      background: linear-gradient(90deg, rgba(197,160,89,.10), transparent 65%);
      border-bottom:1px solid rgba(2,6,23,.06);
    }
    .modalBody{ padding:18px; }
    .field{
      width:100%;
      border-radius:16px;
      border:1px solid rgba(2,6,23,.10);
      padding:12px 14px;
      font-weight:700;
      background:#fff;
    }
    .field:focus{ outline:none; box-shadow:0 0 0 3px rgba(197,160,89,.25); border-color: rgba(197,160,89,.45); }
  </style>
</head>

<body class="pb-16">

  <!-- AUTH OVERLAY -->
  <div id="authOverlay" class="modalWrap" style="display:none;">
    <div class="modal">
      <div class="modalHead">
        <div class="text-[10px] tracking-[0.22em] font-extrabold uppercase text-[color:var(--accent)]">F√®s ‚Äî Maroc</div>
        <div class="flex items-baseline gap-2 mt-1">
          <div class="text-lg font-extrabold tracking-tight">GREY CORNER</div>
          <div class="text-[11px] font-bold text-slate-500">‚Ä¢ Connexion</div>
        </div>
        <div class="text-[11px] font-bold text-slate-600 mt-2">
          Compte <span class="font-extrabold">√©quipe</span> ou <span class="font-extrabold">g√©rant</span>
        </div>
      </div>

      <div class="modalBody">
        <div class="grid gap-3">
          <div>
            <label class="text-[11px] font-extrabold text-slate-600">Email</label>
            <input id="loginEmail" type="email" class="field mt-1" placeholder="equipe@greycorner.com" autocomplete="username" />
          </div>

          <div>
            <label class="text-[11px] font-extrabold text-slate-600">Mot de passe</label>
            <input id="loginPass" type="password" class="field mt-1" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          </div>

          <div class="flex items-center justify-between gap-3">
            <label class="flex items-center gap-2 text-[11px] font-bold text-slate-600">
              <input id="rememberMe" type="checkbox" class="accent-[color:var(--accent)]" checked />
              Rester connect√©
            </label>

            <button id="btnLogin" class="btn px-4 py-3 rounded-2xl shadowSoft bg-[color:var(--primary)] text-white font-extrabold text-[12px] tracking-wide">
              üîê Se connecter
            </button>
          </div>

          <div id="loginError" class="hidden text-[12px] font-extrabold text-red-700 bg-red-50 border border-red-200 rounded-2xl px-4 py-3">
            ‚Äî
          </div>

          <div class="text-[11px] text-slate-500 font-semibold leading-snug">
            R√®gles :
            <ul class="list-disc pl-5 mt-1">
              <li><b>√âquipe</b> : peut modifier <b>IN/OUT</b> et <b>hP</b> uniquement sur <b>aujourd‚Äôhui</b>. Ne peut <b>jamais</b> modifier <b>hA</b>.</li>
              <li><b>G√©rant</b> : acc√®s total (toutes dates, hP/hA/IN/OUT).</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top bar -->
  <div class="stickyTop glass border-b border-black/5">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex-1 min-w-0">
        <div class="text-[10px] tracking-[0.22em] font-extrabold uppercase text-[color:var(--accent)]">F√®s ‚Äî Maroc</div>
        <div class="flex items-baseline gap-2">
          <h1 class="text-lg sm:text-xl font-extrabold tracking-tight truncate">GREY CORNER</h1>
          <span class="text-[11px] font-bold text-slate-500">‚Ä¢ Feuille de pr√©sence</span>
        </div>

        <div id="roleLine" class="mt-1 text-[10px] font-extrabold uppercase tracking-[0.22em] text-slate-500">
          Mode : ‚Äî
        </div>
      </div>

      <div class="flex items-center gap-2">
        <div id="whoami" class="hidden sm:block text-[11px] font-extrabold text-slate-500"></div>
        <button id="btnLogout"
                class="btn px-3 py-2 rounded-full text-[11px] font-extrabold tracking-wide border border-[color:var(--accent)] text-[color:var(--accent)] bg-white hover:brightness-95">
          ‚éã D√©connexion
        </button>
      </div>
    </div>

    <div class="max-w-3xl mx-auto px-4 pb-3">
      <div class="grid grid-cols-1 sm:grid-cols-[1fr_auto] gap-3 items-center">
        <div class="grid grid-cols-1 sm:grid-cols-[220px_1fr] gap-3 items-center">
          <input type="date" id="datePicker"
                 class="w-full px-4 py-3 rounded-2xl card shadow-sm font-bold text-sm accentRing bg-white" />

          <div class="flex gap-2 flex-wrap">
            <button onclick="setFilter('all')" id="chip-all" class="chip chipBtn chip active px-3 py-2 rounded-full text-[11px] font-extrabold text-slate-700">Tous</button>
            <button onclick="setFilter('present')" id="chip-present" class="chip chipBtn px-3 py-2 rounded-full text-[11px] font-extrabold text-slate-700">Pr√©sents</button>
            <button onclick="setFilter('absent')" id="chip-absent" class="chip chipBtn px-3 py-2 rounded-full text-[11px] font-extrabold text-slate-700">Absents</button>
            <button onclick="setFilter('late')" id="chip-late" class="chip chipBtn px-3 py-2 rounded-full text-[11px] font-extrabold text-slate-700">Retard</button>
            <button onclick="setFilter('incomplete')" id="chip-incomplete" class="chip chipBtn px-3 py-2 rounded-full text-[11px] font-extrabold text-slate-700">Incomplet</button>
          </div>
        </div>

        <div class="flex gap-2 sm:justify-end items-stretch">
          <input id="searchInput" oninput="applyFilters()"
                 placeholder="Rechercher un nom‚Ä¶"
                 class="w-full sm:w-56 px-4 py-3 rounded-2xl card shadow-sm text-sm font-semibold accentRing bg-white" />
        </div>
      </div>
    </div>
  </div>

  <main class="max-w-3xl mx-auto px-4 pt-4">
    <!-- Summary -->
    <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 mb-5">
      <div class="card rounded-2xl p-3">
        <div class="text-[10px] font-extrabold tracking-[0.16em] uppercase text-slate-500">Total</div>
        <div id="kpiTotal" class="text-2xl font-extrabold tracking-tight mt-1">‚Äî</div>
      </div>
      <div class="card rounded-2xl p-3">
        <div class="text-[10px] font-extrabold tracking-[0.16em] uppercase text-slate-500">Pr√©sents</div>
        <div id="kpiPresent" class="text-2xl font-extrabold tracking-tight mt-1">‚Äî</div>
      </div>
      <div class="card rounded-2xl p-3">
        <div class="text-[10px] font-extrabold tracking-[0.16em] uppercase text-slate-500">Absents</div>
        <div id="kpiAbsent" class="text-2xl font-extrabold tracking-tight mt-1">‚Äî</div>
      </div>
      <div class="card rounded-2xl p-3">
        <div class="text-[10px] font-extrabold tracking-[0.16em] uppercase text-slate-500">Retards</div>
        <div id="kpiLate" class="text-2xl font-extrabold tracking-tight mt-1">‚Äî</div>
      </div>
      <div class="card rounded-2xl p-3 col-span-2 sm:col-span-1">
        <div class="text-[10px] font-extrabold tracking-[0.16em] uppercase text-slate-500">Minutes retard</div>
        <div id="kpiLateMin" class="text-2xl font-extrabold tracking-tight mt-1">‚Äî</div>
      </div>
    </div>

    <!-- Staff list -->
    <div id="staffList" class="space-y-6"></div>

    <div class="mt-10 text-center text-slate-400 text-[10px] font-extrabold uppercase tracking-[0.28em] pb-6">
      &copy; 2026 Grey Corner ‚Ä¢ Service & Hospitalit√©
    </div>
  </main>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // =========================
    // Firebase config (AUTH+DB)
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyC5al_6xWbJC8S0FAvaEnRmx9BvYtGgnAM",
      authDomain: "grey-corner-presence.firebaseapp.com",
      databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "grey-corner-presence",
      storageBucket: "grey-corner-presence.firebasestorage.app",
      messagingSenderId: "730206093359",
      appId: "1:730206093359:web:59e3c145120807f29e46da",
      measurementId: "G-4HCKPGNED7"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // =========================
    // State
    // =========================
    let role = null;               // "gerant" | "equipe"
    let currentFilter = "all";
    let latestDataCache = {};
    let activeListenerRef = null;

    // =========================
    // √âquipe (m√™mes IDs que pointage)
    // =========================
    const EQUIPE = [
      {nom:'BOUCHNAK', prenom:'NAOUAL', poste:'CUISINE'}, // Chef cuisine (hA-only dans vos r√®gles m√©tier)
      {nom: 'ALAOUI', prenom: 'LAZIZ', poste: 'SERVICE'}, {nom: 'BELQASSE', prenom: 'KHAOULA', poste: 'CUISINE'},
      {nom: 'BENKHADA', prenom: 'ABDESLAM', poste: 'CAISSE'}, {nom: 'BOURAHMA', prenom: 'ANAS', poste: 'CUISINE'},
      {nom: 'CHKAIRI', prenom: 'YOUSSEF', poste: 'BAR'}, {nom: 'ELKOBBI', prenom: 'MOSTAFA', poste: 'BAR'},
      {nom: 'ELGORRAMY', prenom: 'ANISSA', poste: 'MENAGE'}, {nom: 'ELGORRAMY', prenom: 'SOUAD', poste: 'MENAGE'},
      {nom: 'ELMCHAOURI', prenom: 'SOUAD', poste: 'MENAGE'}, {nom: 'ENNHAILI', prenom: 'SOUMIA', poste: 'ECONOMAT'},
      {nom: 'FILALI', prenom: 'ABDERAFI', poste: 'BAR'}, {nom: 'GUETIBI', prenom: 'AMINE', poste: 'SERVICE'},
      {nom: 'HATTAF', prenom: 'MOHAMED', poste: 'SERVICE'}, {nom: 'HIDARA', prenom: 'YOUSSEF', poste: 'SERVICE'},
      {nom: 'IDRISSI', prenom: 'SAAD', poste: 'CUISINE'}, {nom: 'KAFOUNI', prenom: 'ZAKARIAE', poste: 'SERVICE'},
      {nom: 'KHALOUQ', prenom: 'RACHID', poste: 'BAR'}, {nom: 'LEMSSIEH', prenom: 'JAWAD', poste: 'CUISINE'},
      {nom: 'MAJDOUB', prenom: 'JIHANE', poste: 'CUISINE'}, {nom: 'MOHSINE', prenom: 'YOUNESS', poste: 'SERVICE'},
      {nom: 'MOUJAHID', prenom: 'IMANE', poste: 'CUISINE'}, {nom: 'SALIL', prenom: 'HOUDA', poste: 'CAISSE'},
      {nom: 'SBAI', prenom: 'HAKIMA', poste: 'MENAGE'}, {nom: 'ZAIR', prenom: 'FATIMA', poste: 'CUISINE'}
    ];

    function empId(emp){ return `${emp.nom}_${emp.prenom}`; }

    // =========================
    // Date Maroc
    // =========================
    const getMarocDate = () =>
      new Intl.DateTimeFormat('fr-CA', {
        timeZone: 'Africa/Casablanca',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      }).format(new Date());

    // =========================
    // Time helpers
    // =========================
    function timeToMin(t){
      if(!t || typeof t !== "string" || !t.includes(":")) return null;
      const parts = t.split(":").map(Number);
      if(parts.length !== 2) return null;
      const h = parts[0], m = parts[1];
      if(Number.isNaN(h) || Number.isNaN(m)) return null;
      return h*60+m;
    }

    function lateMinutes(hP, hA){
      const p = timeToMin(hP);
      const a = timeToMin(hA);
      if(p === null || a === null) return null;
      return Math.max(0, a - p);
    }

    function fmtLate(min){
      if(min === null) return "‚Äî";
      if(min <= 0) return "√Ä l'heure";
      return `+${min} min`;
    }

    // =========================
    // Permissions (IMPORTANT)
    // - equipe : peut modifier on/off + hP uniquement sur aujourd'hui
    // - equipe : NE MODIFIE JAMAIS hA (sur presence)
    // - gerant : acc√®s total
    // =========================
    function isGerant(){ return role === "gerant"; }
    function isEquipe(){ return role === "equipe"; }

    function canEquipeEditToday(selectedDate){
      return isEquipe() && selectedDate === getMarocDate();
    }

    function canEditHP(selectedDate){
      return isGerant() || canEquipeEditToday(selectedDate);
    }

    function canEditInOut(selectedDate){
      return isGerant() || canEquipeEditToday(selectedDate);
    }

    function canEditHA(id, selectedDate){
  // g√©rant => toujours
  if(isManager) return true;

  // uniquement aujourd'hui
  if(selectedDate !== getMarocDate()) return false;

  // ‚úÖ Exception hA (Souad + Hakima)
  if(haExceptionsToday.includes(id)) return true;

  // Chef hA-only (si tu veux garder)
  if(haOnly.includes(id)) return true;

  // sinon √©quipe/caisse ne modifie pas hA
  return false;
}

    // =========================
    // CRUD
    // =========================
    function upd(id, f, v){
      const date = document.getElementById('datePicker').value;
      return database.ref('presences/'+date+'/'+id).update({[f]:v});
    }

    // =========================
    // Filters UI
    // =========================
    function setFilter(f){
      currentFilter = f;
      document.querySelectorAll(".chipBtn").forEach(b => b.classList.remove("active"));
      const btn = document.getElementById(`chip-${f}`);
      if(btn) btn.classList.add("active");
      applyFilters();
    }

    function applyFilters(){
      const q = (document.getElementById("searchInput").value || "").trim().toLowerCase();
      const cards = document.querySelectorAll("#staffList .empCard");

      cards.forEach(card => {
        const matchName = (card.dataset.name || "").includes(q);

        let matchFilter = true;
        if(currentFilter === "present") matchFilter = card.dataset.present === "1";
        if(currentFilter === "absent") matchFilter = card.dataset.present === "0";
        if(currentFilter === "late") matchFilter = card.dataset.late === "1";
        if(currentFilter === "incomplete") matchFilter = card.dataset.incomplete === "1";

        card.style.display = (matchName && matchFilter) ? "block" : "none";
      });
    }

    // =========================
    // Render
    // =========================
    function render(){
      if(!role) return;

      const selectedDate = document.getElementById('datePicker').value;
      const list = document.getElementById('staffList');
      list.innerHTML = "";

      const groupes = EQUIPE.reduce((acc, emp) => {
        (acc[emp.poste] = acc[emp.poste] || []).push(emp);
        return acc;
      }, {});

      Object.keys(groupes).sort().forEach(poste => {
        const section = document.createElement('section');
        section.className = "card rounded-3xl overflow-hidden";

        const header = document.createElement('button');
        header.type = "button";
        header.className = "w-full flex items-center justify-between px-4 py-4 bg-white";
        header.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="sectionTitle text-xs font-extrabold tracking-[0.18em] uppercase text-slate-500">${poste}</div>
          </div>
          <div class="flex items-center gap-2">
            <span class="badge">${groupes[poste].length} pers.</span>
            <span class="text-slate-400 font-black">‚ñæ</span>
          </div>
        `;

        const body = document.createElement('div');
        body.className = "px-4 pb-4 space-y-3";

        let open = true;
        header.addEventListener('click', () => {
          open = !open;
          body.style.display = open ? "block" : "none";
        });

        groupes[poste]
          .slice()
          .sort((a,b)=> (a.nom+a.prenom).localeCompare(b.nom+b.prenom))
          .forEach(emp => {
            const id = empId(emp);
            const d = latestDataCache[id] || {};

            const isPresent = !!d.on;
            const isOut = !!d.off;
            const hasHP = !!d.hP;
            const hasHA = !!d.hA;

            // Incomplet: pr√©sent sans hP/hA, ou absent avec des champs remplis
            const incomplete =
              (isPresent && (!hasHP || !hasHA)) ||
              (!isPresent && (hasHP || hasHA || isOut));

            const lm = lateMinutes(d.hP, d.hA);
            const isLate = (lm !== null && lm > 0);

            const statusBadges = [];
            statusBadges.push(isPresent ? `<span class="badge ok">Pr√©sent</span>` : `<span class="badge bad">Absent</span>`);
            if(isOut) statusBadges.push(`<span class="badge">Sorti</span>`);
            if(isLate) statusBadges.push(`<span class="badge warn">Retard ${fmtLate(lm)}</span>`);
            if(incomplete) statusBadges.push(`<span class="badge">Incomplet</span>`);

            const card = document.createElement('div');
            card.className = "card rounded-2xl p-4 empCard";
            card.dataset.name = `${emp.nom} ${emp.prenom}`.toLowerCase();
            card.dataset.present = isPresent ? "1" : "0";
            card.dataset.late = isLate ? "1" : "0";
            card.dataset.incomplete = incomplete ? "1" : "0";

            const canInOut = canEditInOut(selectedDate);
            const canHP = canEditHP(selectedDate);
            const canHA = canEditHA(selectedDate);

            card.innerHTML = `
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class="font-extrabold text-sm tracking-tight text-slate-900 truncate">
                    ${emp.nom} ${emp.prenom}
                  </div>
                  <div class="mt-2 flex gap-2 flex-wrap">
                    ${statusBadges.join("")}
                  </div>
                </div>

                <div class="toggleWrap rounded-2xl p-2 flex gap-2">
                  <label class="flex flex-col items-center px-1">
                    <span class="text-[9px] font-extrabold text-slate-400 tracking-wide">IN</span>
                    <input type="checkbox" class="w-4 h-4 accent-[color:var(--accent)]"
                      ${isPresent ? "checked" : ""} ${canInOut ? "" : "disabled"}
                      onchange="upd('${id}','on',this.checked)">
                  </label>
                  <label class="flex flex-col items-center px-1">
                    <span class="text-[9px] font-extrabold text-slate-400 tracking-wide">OUT</span>
                    <input type="checkbox" class="w-4 h-4 accent-[color:var(--accent)]"
                      ${isOut ? "checked" : ""} ${canInOut ? "" : "disabled"}
                      onchange="upd('${id}','off',this.checked)">
                  </label>
                </div>
              </div>

              <div class="mt-4 grid grid-cols-2 gap-3">
                <div>
                  <label class="text-[10px] font-extrabold tracking-[0.14em] uppercase text-slate-500 mb-1 block">Shift pr√©vu (hP)</label>
                  <input type="time"
                    class="w-full bg-[color:var(--soft)] rounded-xl text-sm font-bold px-3 py-2 accentRing"
                    value="${d.hP || ""}"
                    ${canHP ? "" : "disabled"}
                    onchange="upd('${id}','hP',this.value)">
                </div>

                <div>
                  <label class="text-[10px] font-extrabold tracking-[0.14em] uppercase text-slate-500 mb-1 block">Arriv√©e r√©elle (hA)</label>
                  ${
                    canHA
                    ? `<input type="time"
                        class="w-full rounded-xl text-sm font-extrabold px-3 py-2 accentRing"
                        style="background: rgba(197,160,89,.10); border:1px solid rgba(197,160,89,.30)"
                        value="${d.hA || ""}"
                        onchange="upd('${id}','hA',this.value)">`
                    : `<div class="w-full bg-slate-100 rounded-xl text-sm font-extrabold px-3 py-2 text-slate-500 text-center">
                        ${d.hA || "--:--"}
                      </div>`
                  }
                </div>
              </div>
            `;

            body.appendChild(card);
          });

        section.appendChild(header);
        section.appendChild(body);
        list.appendChild(section);
      });

      computeKPIs();
      applyFilters();
    }

    function computeKPIs(){
      const total = EQUIPE.length;
      let present = 0, absent = 0, lateCount = 0, lateMinSum = 0;

      EQUIPE.forEach(emp => {
        const id = empId(emp);
        const d = latestDataCache[id] || {};
        const isPresent = !!d.on;
        if(isPresent) present++; else absent++;

        const lm = lateMinutes(d.hP, d.hA);
        if(lm !== null && lm > 0){
          lateCount++;
          lateMinSum += lm;
        }
      });

      document.getElementById("kpiTotal").textContent = total;
      document.getElementById("kpiPresent").textContent = present;
      document.getElementById("kpiAbsent").textContent = absent;
      document.getElementById("kpiLate").textContent = lateCount;
      document.getElementById("kpiLateMin").textContent = lateMinSum;
    }

    // =========================
    // Load (listener par date)
    // =========================
    function load(){
      if(!role) return;

      const selectedDate = document.getElementById('datePicker').value;

      if(activeListenerRef){
        activeListenerRef.off();
      }

      activeListenerRef = database.ref('presences/' + selectedDate);
      activeListenerRef.on('value', snap => {
        latestDataCache = snap.val() || {};
        render();
      });
    }

    // =========================
    // UI role line
    // =========================
    function updateRoleLine(userEmail){
      const line = document.getElementById("roleLine");
      const who = document.getElementById("whoami");
      who.classList.remove("hidden");
      who.textContent = userEmail ? userEmail : "";

      if(isGerant()){
        line.textContent = "Mode : G√âRANT (Acc√®s total ‚úÖ)";
      } else if(isEquipe()){
        line.textContent = "Mode : √âQUIPE (Aujourd‚Äôhui : IN/OUT + hP ‚úÖ | hA ‚ùå)";
      } else {
        line.textContent = "Mode : ‚Äî";
      }
    }

    // =========================
    // Auth flow
    // =========================
    function showAuth(show){
      document.getElementById("authOverlay").style.display = show ? "flex" : "none";
    }

    async function fetchRole(uid){
      const snap = await database.ref("users/" + uid).once("value");
      const v = snap.val();
      // attendu: "gerant" ou "equipe"
      return (v === "gerant" || v === "equipe") ? v : null;
    }

    async function doLogin(){
      const email = (document.getElementById("loginEmail").value || "").trim();
      const pass  = (document.getElementById("loginPass").value || "").trim();
      const remember = !!document.getElementById("rememberMe").checked;

      const errBox = document.getElementById("loginError");
      errBox.classList.add("hidden");
      errBox.textContent = "‚Äî";

      if(!email || !pass){
        errBox.textContent = "Veuillez saisir email + mot de passe.";
        errBox.classList.remove("hidden");
        return;
      }

      try{
        await auth.setPersistence(
          remember ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION
        );
        await auth.signInWithEmailAndPassword(email, pass);
      }catch(e){
        errBox.textContent = (e && e.message) ? e.message : "Erreur connexion.";
        errBox.classList.remove("hidden");
      }
    }

    document.getElementById("btnLogin").addEventListener("click", doLogin);
    document.getElementById("loginPass").addEventListener("keydown", (e)=>{
      if(e.key === "Enter") doLogin();
    });

    document.getElementById("btnLogout").addEventListener("click", async ()=>{
      try{ await auth.signOut(); }catch(e){}
    });

    auth.onAuthStateChanged(async (user)=>{
      // reset state/listeners
      latestDataCache = {};
      if(activeListenerRef){ activeListenerRef.off(); activeListenerRef = null; }

      if(!user){
        role = null;
        updateRoleLine("");
        showAuth(true);
        document.getElementById("staffList").innerHTML = "";
        document.getElementById("kpiTotal").textContent = "‚Äî";
        document.getElementById("kpiPresent").textContent = "‚Äî";
        document.getElementById("kpiAbsent").textContent = "‚Äî";
        document.getElementById("kpiLate").textContent = "‚Äî";
        document.getElementById("kpiLateMin").textContent = "‚Äî";
        return;
      }

      // logged in -> get role from DB
      try{
        role = await fetchRole(user.uid);
        if(!role){
          showAuth(true);
          const errBox = document.getElementById("loginError");
          errBox.textContent = "Votre utilisateur n'a pas de r√¥le dans /users/{uid}. Ajoutez 'gerant' ou 'equipe'.";
          errBox.classList.remove("hidden");
          await auth.signOut();
          return;
        }

        updateRoleLine(user.email || "");
        showAuth(false);

        // init date
        const dp = document.getElementById('datePicker');
        if(!dp.value) dp.value = getMarocDate();

        // If equipe, force date = today (optionnel). Si tu veux autoriser lecture historique, supprime ce bloc.
        // Ici on autorise lecture historique (pas d'√©dition). Donc on ne force pas la date.

        load();
      }catch(e){
        showAuth(true);
        const errBox = document.getElementById("loginError");
        errBox.textContent = "Erreur r√¥le/auth : " + ((e && e.message) ? e.message : "");
        errBox.classList.remove("hidden");
        try{ await auth.signOut(); }catch(_){}
      }
    });

    // =========================
    // Init
    // =========================
    (function initApp(){
      const dp = document.getElementById('datePicker');
      dp.value = getMarocDate();
      dp.addEventListener('change', load);
      // overlay visible until auth resolves
      showAuth(true);
    })();
  </script>
</body>
</html>